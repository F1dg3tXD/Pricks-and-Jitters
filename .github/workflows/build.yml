name: Build PJ

on: 
  workflow_dispatch:

jobs:
  export_game:
    runs-on: windows-latest
    permissions: write-all
    name: Export Game
    steps:
    
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Install dependencies and extract files
      run: |
        # Download and install Godot 4.3
        Invoke-WebRequest -Uri https://github.com/godotengine/godot-builds/releases/download/4.3-stable/Godot_v4.3-stable_win64.exe.zip -OutFile Godot_v4.3-stable_win64.exe.zip
        Expand-Archive -Path Godot_v4.3-stable_win64.exe.zip -DestinationPath C:\Godot
        Start-Process -FilePath C:\Godot\Godot_v4.3-stable_win64.exe -ArgumentList "/S" -Wait

        # Download and install Godot export templates
        Invoke-WebRequest -Uri https://github.com/godotengine/godot-builds/releases/download/4.3-stable/Godot_v4.3-stable_export_templates.tpz -OutFile Godot_v4.3-stable_export_templates.tpz
        Expand-Archive -Path Godot_v4.3-stable_export_templates.tpz -DestinationPath C:\Godot\Templates
        
        # Download and install Blender 4.3.2
        Invoke-WebRequest -Uri https://www.blender.org/download/release/Blender4.3/blender-4.3.2-windows-x64.zip -OutFile blender-4.3.2-windows-x64.zip
        Expand-Archive -Path blender-4.3.2-windows-x64.zip -DestinationPath C:\Blender
        
    - name: Set Blender path in Godot
      run: |
        # Set the Blender path in Godot to point to the installed Blender 4.3.2 path
        $blender_path = "C:\Blender\blender-4.3.2-windows-x64\blender.exe"
        $godot_config_path = "$env:APPDATA\Godot\Godot_v4.3-stable\config.cfg"
        if (Test-Path $godot_config_path) {
          Add-Content -Path $godot_config_path -Value "blender_path=$blender_path"
        } else {
          Write-Host "Godot config not found. Skipping Blender path setup."
        
    - name: Install Godot export templates
      run: |
        # Set the Godot export templates path to the custom directory
        $godot_config_path = "$env:APPDATA\Godot\Godot_v4.3-stable\config.cfg"
        if (Test-Path $godot_config_path) {
          Add-Content -Path $godot_config_path -Value "export_templates_path=C:\Godot\Templates"
        } else {
          Write-Host "Godot config not found. Skipping export templates path setup."

    - name: Open Godot project and import assets
      run: |
        # Open the project in Godot to trigger asset imports (make sure Godot project is located in the repo)
        Start-Process -FilePath "C:\Godot\Godot_v4.3-stable_win64.exe" -ArgumentList "--headless", "--path", "$PWD"

    - name: Wait for asset import
      run: |
        # Wait for assets to finish importing (adjust time if necessary)
        Start-Sleep -Seconds 30

    - name: Export Game using export_presets.cfg
      run: |
        # Ensure export_presets.cfg exists and use it to export executables
        $export_presets = "$PWD\export_presets.cfg"
        if (Test-Path $export_presets) {
          Start-Process -FilePath "C:\Godot\Godot_v4.3-stable_win64.exe" -ArgumentList "--headless", "--export", $export_presets
        } else {
          Write-Host "No export_presets.cfg file found. Skipping export."
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: exported-builds
        path: |
          $PWD\*.exe
          $PWD\*.pck
          $PWD\*.zip
          $PWD\*.dmg
          $PWD\*.x86_64
          $PWD\*.app
